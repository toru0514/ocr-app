# 📦 経理取引前処理アプリ（MVP）

Amazon・楽天などの領収書PDFを整理し、弥生の「スマート取引取込 → CSVファイル取込」で読み込める仕訳データを効率よく作成するための前処理アプリです。本アプリは完全自動化ではなく「手入力を劇的にラクにする」ことを目的としたMVPとして構築し、将来的に PDF 解析 / OCR / 自動ダウンロードを追加できる拡張性を確保します。

## 🎯 目的（Purpose）
- ネット通販（Amazon / 楽天 / 各種ショップ）の領収書PDFを整理し、取引データを効率的に作成する。
- 作成した取引データを弥生の白色申告オンライン「スマート取引取込 → CSVファイル取込」にそのまま渡せる形式に整える。
- 「PDF見ながら入力 → CSV作成 → 弥生にポイッ」を最小労力で実現する年間経費記帳フローを確立する。

## 💡 アプリの概要
このアプリは「経理アプリ」ではなく「経理前処理アプリ」。以下の一連の作業を自分に最適化された UI & データ構造で完結させます。
1. PDFをアップロード
2. 日付 / 金額 / 相手先 / 科目 / 摘要を入力
3. 複数件まとめて CSV に書き出す
4. 弥生で取り込む

> **金額ポリシー**：本アプリでは金額はすべて税込金額（円）で管理し、税抜計算は行わない。

## 🔧 技術スタック（予定）
- Next.js（App Router）
- TypeScript
- Tailwind CSS
- shadcn/ui
- Supabase（Auth / DB / Storage）
- アーキテクチャ方針：軽量ヘキサゴナル / DDD風

## 🧱 機能要件（MVP）
### 1. PDFアップロード + 一覧表示
- PDF（1件~複数件）をアップロードしてドキュメント一覧に保存
- 管理項目：アップロード日 / ファイル名 / 入力状態（未入力・入力中・確定）/ 結びついた仕訳数 / 合計金額（任意）

### 2. 仕訳編集（Entry Editor）
- 各PDFに対して1件〜複数件の仕訳行を登録
- 入力項目：取引日 / 相手先 / 勘定科目 / 金額 / 税区分（10%・8%・非課税）/ 摘要
- フォーム入力しやすい画面構成にし、将来的に「PDFプレビュー + ハイライト抽出」を追加できるようにする

### 3. CSVエクスポート（弥生取込用）
- 対象期間（開始日〜終了日）を指定して抽出
- confirmed 状態の仕訳データのみ対象
- 弥生の「CSVファイル取込」に合わせたカラムで出力し、ダウンロード可能（列マッピングにも対応できる汎用形式）
- CSV列案：date / amount_in / amount_out / vendor / account_title / tax_category / description / document_id

### 4. 状態管理
- `draft`（未入力）
- `in_review`（編集途中）
- `confirmed`（確定済み → CSV対象）

## 📂 データ構造（DB設計案）
```text
documents
  id (uuid, PK)
  original_name (text)
  storage_path (text)
  status (text) -- draft, in_review, confirmed
  created_by (uuid)
  created_at (timestamptz)
  updated_at (timestamptz)
  source (text) -- amazon, rakuten, manual
  note (text)

entries（仕訳行）
  id (uuid, PK)
  document_id (uuid, FK -> documents.id)
  created_by (uuid)
  date (date)
  vendor (text)
  account_title (text)
  amount (integer)
  tax_category (text)
  description (text)
  created_at (timestamptz)
  updated_at (timestamptz)
```

### Supabase テーブル定義（A1-01）
#### documents
| column | type | constraints / default | note |
| --- | --- | --- | --- |
| id | uuid | PK, `default gen_random_uuid()` | Supabase 既定の UUID 生成を使用 |
| original_name | text | NOT NULL | アップロードした元ファイル名 |
| storage_path | text | NOT NULL, UNIQUE | Supabase Storage のパス（例：`receipts/{year}/{uuid}.pdf`） |
| status | text | NOT NULL, `default 'draft'`, CHECK (`draft`,`in_review`,`confirmed`) | ドキュメントの入力状態 |
| source | text | NOT NULL, `default 'manual'`, CHECK (`amazon`,`rakuten`,`manual`,`other`) | 取得元（UI フィルタ用） |
| created_by | uuid | NOT NULL | Supabase `auth.users.id`。RLS の参照キー |
| note | text | NULL | 補足メモ |
| created_at | timestamptz | NOT NULL, `default now()` | Supabase の `created_at` 既定を利用 |
| updated_at | timestamptz | NOT NULL, `default now()` | Supabase trigger で更新 |

推奨インデックス：`status`, `created_at DESC`, `source+status` の複合。ストレージは `receipt-documents` バケットに集約し、`storage_path` は bucket 内相対パスを記録する。

#### entries
| column | type | constraints / default | note |
| --- | --- | --- | --- |
| id | uuid | PK, `default gen_random_uuid()` | 仕訳行 ID |
| document_id | uuid | NOT NULL, FK → documents.id `ON DELETE CASCADE` | 親ドキュメントと常に紐付ける |
| date | date | NOT NULL | 取引日（弥生 CSV の date カラム） |
| vendor | text | NOT NULL | 相手先（Amazon / 楽天ショップ名など） |
| account_title | text | NOT NULL | 勘定科目（標準セットから選択） |
| amount | integer | NOT NULL, CHECK (> 0) | 税込金額（円、正の整数） |
| tax_category | text | NOT NULL, CHECK (`standard_10`,`reduced_8`,`exempt`) | 弥生 CSV の税区分と一致させる |
| created_by | uuid | NOT NULL | 行を登録したユーザー |
| description | text | NULL | 摘要（任意） |
| created_at | timestamptz | NOT NULL, `default now()` | |
| updated_at | timestamptz | NOT NULL, `default now()` | |

推奨インデックス：`document_id`（必須）、`date`, `vendor+date`。document 削除時は cascade で entries も削除される。`tax_category` は README に定義した選択肢以外を禁止する。

> **型ポリシー**：`status` / `source` / `tax_category` などの列は当面 text + CHECK 制約で実装し、将来的に enum 型へ移行する余地を残す。

### マイグレーション & ストレージ命名規則（A1-02）
#### Migration 方針
- Supabase CLI（`supabase/migrations`）を利用し、1 マイグレーション = 1 意味単位で管理する。
- 初期マイグレーション名：`YYYYMMDDHHMMSS_init_documents_entries.sql`
  - `documents` / `entries` テーブル作成、CHECK 制約、インデックスまでを含める。
  - 追加テーブルや関数が必要な場合は `YYYYMMDDHHMMSS_add_<feature>.sql` 形式とする。
- CLI での作成例：`supabase migration new init_documents_entries`
- マイグレーション適用順はタイムスタンプで保証されるため、命名時刻は実行順を意識して付与する。
- ローカル検証後に `supabase db push` で Supabase プロジェクトへ反映し、README にバージョンを記録する。

#### Storage バケット & パス
- バケット名：`receipt-documents`（public=false）。アクセスポリシーは認証済みユーザーのみ read/write 可能。
- ファイルパス形式：`receipts/{yyyy}/{documentId}/{timestamp}_{sanitizedOriginalName}.pdf`
  - `{documentId}` は documents.id（UUID）。
  - `{timestamp}` はアップロード時の UTC `yyyyMMddHHmmss`。
  - `sanitizedOriginalName` は半角英数字・ハイフン・アンダースコアに正規化（日本語やスペースは `_` に置換）。
- サムネイルや OCR など追加ファイルは `receipts/{yyyy}/{documentId}/extra/{type}_{timestamp}.json` のように `extra` サブディレクトリを使用。
- 同一 PDF の再アップロード時は document を新規生成し、既存 `storage_path` を更新しない（履歴保持）。
- Supabase Storage API へ書き込み完了後に `documents.storage_path` を確定させる。失敗時はアップロードと DB どちらもロールバックする。

### ステータス遷移モデル（A1-03）
#### ステータス定義
| status | 意味 | 編集可否 | CSV対象 |
| --- | --- | --- | --- |
| `draft` | PDF アップロード直後。仕訳未入力または途中 | 〇（全項目編集可能） | ✕ |
| `in_review` | 入力が一通り終わり確認中 | 〇（行編集可。主要フィールドは edit log を残す） | ✕ |
| `confirmed` | 弥生連携用に確定した状態 | △（直接編集不可。in_review へ戻す操作のみ許可） | 〇 |

#### 遷移ルール
| from | to | 必須条件 / 備考 |
| --- | --- | --- |
| `draft` | `in_review` | `entries` が 1 件以上、全行で `date`,`vendor`,`account_title`,`amount`,`tax_category` が入力済み。保存時に sum(amount) を documents 合計として記録。 |
| `in_review` | `draft` | 修正点が多い場合に戻す操作。戻した時点で `confirmed_by` などのメタ情報はクリア。 |
| `in_review` | `confirmed` | 合計金額・税区分が要件を満たしていること、未入力項目がないこと、マイナーバリデーション（文字数・税区分）に合格していること。確定時に `confirmed_at`, `confirmed_by` を documents メタに記録。 |
| `confirmed` | `in_review` | 修正が必要になった場合のみ許容。戻すと CSV 対象から自動除外し、履歴に「再オープン」イベントを記録。 |

- `confirmed` → `draft` への直接遷移は不可。大幅修正は `in_review` へ戻した上で `draft` へ遷移する。
- `entries` は documents のステータスに連動し、`confirmed` 状態では直接編集できない。編集したい場合は documents を `in_review` に戻す必要がある。
- ステータス変更権限：`draft → in_review` は入力者、`in_review → confirmed` はレビュー権限を持つユーザー（初期は同一ユーザー想定）に限定。Supabase Auth のロール／RLS で制御。

### PDF アップロード UX 設計（A2-01）
#### ユーザーフロー
1. `/documents` で「PDF をアップロード」ボタンまたはドロップゾーンにアクセス。
2. ドラッグ＆ドロップまたはファイル選択で 1 件〜複数件を追加。
3. モーダル / サイドバーでファイルごとのプレビュー（ファイル名・サイズ・ステータス）を表示。
4. 「アップロード開始」クリックで順次アップロード。
5. 完了すると一覧に `draft` 状態のドキュメントが追加される。

#### UI 要素
- ドロップゾーン：大きめの矩形エリアに「PDF をドラッグ＆ドロップ（複数可）」テキスト。クリックでファイル選択も可能。
- ファイルリスト：アップロードキューをリスト表示し、各行に以下を表示。
  - サムネイル（PDF アイコン）
  - ファイル名（15 文字超は省略表示）
  - ファイルサイズ（MB 表示）
  - ステータスバッジ（待機 / アップロード中 / 完了 / 失敗）
  - 再試行 / 削除ボタン
- 制限表示：最大 20 ファイル / 1 回、1 ファイルあたり 10MB の制限をヘルプテキストに記載。
- 進捗バー：全体進捗（%）+ 個別進捗バー。キャンセルボタンでアップロード全体を停止可能。
- エラートースト：禁止ファイル形式、サイズ超過、ネットワークエラーなどを即時通知。再試行方法へのリンクを含む。

#### バリデーション / エラーハンドリング
- クライアント側：拡張子 `.pdf` のみ許可、MIME チェック、サイズ上限チェック。
- サーバー側：Supabase Storage でも MIME/サイズを再検証し、失敗時にエラーコードを返す。
- 同名ファイルの扱い：`original_name` はそのまま保存し、`storage_path` は UUID ベースのため衝突しない。
- アップロード途中で閉じた場合：リジュームしない。次回アクセス時に失敗ファイルとして表示し、再アップロードを促す。

#### アクセシビリティ / UX 補足
- キーボード操作：ドロップゾーンはボタンとしてフォーカス可能にし、Enter/Space でファイル選択可能。
- 進捗状況はスクリーンリーダー向けに `aria-live="polite"` で告知。
- モバイルではボタン UI を優先し、ファイル選択ダイアログを即表示。
- アップロード完了後に「仕訳入力を始める」ショートカットボタンを表示し、`/documents/[id]` へ遷移可能にする。

### Supabase Storage 連携設計（A2-02）
#### アップロードフロー（クライアント → Supabase）
1. フロントエンドでファイル選択後、`POST /api/upload`（Next.js Route Handler）へメタ情報と共に送信。
2. Route Handler で Supabase Admin クライアントを使い、署名付き URL（`storage.from(bucket).upload()` 前に `createSignedUploadUrl`）を取得。
3. 署名付き URL を用いてクライアントから直接 Storage にアップロード。
4. アップロード成功レスポンス受信後、Route Handler で `documents` レコードを作成し、`storage_path` を保存。
5. 応答として新規 `document.id` や `status` を返し、フロントエンドの一覧に即反映。

#### エラー / リトライ設計
- アップロード失敗時は Storage 側のレスポンスコード別に分類（4xx: 認証/バリデーション、5xx: サーバー）。
- クライアントは指数バックオフ（最大 3 回）で自動リトライ。すべて失敗した場合はユーザーに再試行ボタンを提示。
- `documents` でレコード作成済みなのに Storage が失敗した場合：
  - Transaction 的に扱うため、先に Storage → 成功後に DB の順で実行。
  - もし DB 作成が失敗したら、該当ファイルを Storage から削除して整合性を保つ。
- ネットワーク切断でステータス不明の場合、フロントエンドは `/api/upload/status?tempId=` で確認し、成功していなければ再アップロードを促す。

#### メタデータ / イベント
- Storage upload 時に `metadata` に `document_id`, `source`, `uploaded_by` を付与し、後続処理（OCR など）が参照できるようにする。
- Supabase Functions（Edge Functions）で `storage.objects.insert` をトリガーし、必要に応じてサムネイル生成などの非同期処理に利用する余地を残す（現段階では未実装）。

#### セキュリティ / RLS
- Supabase Storage のポリシー：`auth.role() = 'authenticated'` かつ `metadata.uploaded_by = auth.uid()` のみ read/write 可能にする。
- `documents` / `entries` テーブルの RLS も `created_by = auth.uid()` の行のみ参照可能にし、他人の領収書や仕訳を閲覧できないようにする。
- アップロード API は CSRF 対策として Next.js Route Handler で `POST` のみ受け付け、`same-origin` のみ許可。

### ドキュメント一覧 UI 設計（A2-03）
#### レイアウト
1. 左カラム：フィルターパネル（固定幅 / アコーディオン）
2. 右カラム：一覧テーブル + ページネーション
3. 画面上部：アップロードボタン / ステータス集計サマリ

#### フィルター項目
- 期間：日付レンジピッカー（アップロード日, 取引日の両方を切り替え可能）
- ステータス：`draft` / `in_review` / `confirmed` のチェックボックス（複数選択可）
- ソース：`amazon` / `rakuten` / `manual` / `other`
- 金額帯：最小金額～最大金額の数値入力（任意）
- フリーテキスト検索：ファイル名・note・vendor を対象にした全文検索（Supabase `fts`）

#### 一覧テーブルのカラム
| カラム | 内容 |
| --- | --- |
| PDF | サムネイル or アイコン + プレビューリンク（モーダル） |
| ファイル名 | `original_name`（クリックで `/documents/[id]` へ） |
| ソース | バッジ表示（Amazon/Rakuten等） |
| アップロード日 | `created_at`（`YYYY/MM/DD HH:mm` 表示） |
| 入力状態 | ステータスバッジ（`draft`/`in_review`/`confirmed`） |
| 仕訳数 | entries 件数（`entries_count` 集計ビューを利用） |
| 合計金額 | entries の `amount` 合計（確定時に documents にキャッシュ） |
| 最終更新 | `updated_at`（ステータス変更やエントリ更新時に更新） |
| アクション | `編集` / `複製` / `削除` ボタン（権限に応じて表示） |

#### UX 補足
- 無限スクロールではなくページネーション（50件/ページ）にし、デフォルトはアップロード日降順ソート。
- ステータスごとのカウントバッジをフィルタ上部に表示し、進捗を可視化。
- テーブルの列は将来的にカスタマイズ可能にする余地を残しつつ、MVP では固定。
- 行ホバーでショートアクション（例：`仕訳入力` ショートカット）を表示し、操作ショートカットを提供。
- レスポンシブ対応：タブレット/スマホではカード UI に切り替え、主要項目（ファイル名、ステータス、金額）のみ表示。
- 空状態ではイラスト + 「PDFをアップロード」CTA を表示し、初回ユーザーをガイド。

### 仕訳エディタ フォームレイアウト（A3-01）
#### レイアウト
- 画面左：PDF プレビュー（将来のハイライト追加を想定）
- 画面右：仕訳エディタ（タブ or アコーディオン形式で複数行を編集）
- 上部：document のメタ情報（ファイル名、ソース、ステータス、合計金額）
- 下部：行の追加ボタン、ステータス更新ボタン、保存/破棄ボタン

#### 入力順序 / フィールド
1. 取引日（DatePicker + キーボード入力）
2. 相手先（コンボボックス：過去入力のサジェスト）
3. 勘定科目（セレクト + クイック検索）
4. 金額（数値入力。千区切り表示）
5. 税区分（`10%` / `8%` / `非課税`）
6. 摘要（テキストエリア、複数行）

#### UI コンポーネント
- 行ごとにカード UI を採用し、フォーカス中の行を強調。
- 入力要素は 2 カラム（左：日付・相手先・勘定科目、右：金額・税区分・摘要）。
- キーボードショートカット：
  - `Enter` で次フィールド、`Shift+Enter` で前フィールド
  - `Ctrl/Cmd + Enter` で行保存、`Ctrl/Cmd + D` で行複製、`Delete` で行削除
- エラーは行内のフィールド下にメッセージ表示し、行ヘッダーにも赤バッジで示す。
- 金額フィールドにはリアルタイム合計を表示し、複数行の合計はドキュメントヘッダーに反映。

#### 入力補助
- 相手先：Amazon, 楽天ショップ名など過去の入力履歴からサジェスト（Supabase `entries` から distinct 取得）。
- 勘定科目：あらかじめ定義したリストを検索可能にし、ショートコード（例：`MAT` → 材料費）で選択できる。
- 税区分：ラジオボタン + 説明 ToolTip（例：10% 消費税等）。
- 日付フィールドは前回入力値から自動で +1 日するオプションを用意し、同日連続入力を高速化。

#### 保存 / 状態管理
- 行編集はオートセーブ（2 秒間変更がないと draft 保存）+ 手動保存ボタン。
- 未保存の変更がある場合は離脱ガード（ブラウザの `beforeunload` + アプリ内モーダル）。
- エディタ下部に `draft/in_review/confirmed` の現在状態を表示し、条件を満たしたときのみボタンが活性化する。

### 行操作ロジック設計（A3-02）
#### 行の追加
- 「+ 仕訳行を追加」ボタンで新規カードを末尾に挿入。
- ショートカット `Cmd/Ctrl + Enter` で現在行を保存して次の空行を自動追加。
- 初期値は直前行の `date`/`vendor` を引き継ぎ、`amount` は空、`tax_category` は直前行と同じにする。

#### 行の複製
- 各行に「複製」ボタン。クリックで同じ内容の行を直後に挿入し、`date` と `vendor` を引き継ぐ。
- 複製直後にフォーカスを新行へ移し、金額や摘要のみ変更できるようにする。
- ショートカット `Cmd/Ctrl + D` で複製。

#### 行の削除
- 行右上に削除アイコン。`confirmed` になるまで自由に削除可能。
- 削除時は確認モーダル（「元に戻せます」）を表示。Undo で復元できるよう削除履歴を保持。
- ショートカット `Cmd/Ctrl + Backspace` で削除。

#### 並び替え
- ドラッグ＆ドロップで行順序を入れ替え可能。並び順は `entries.sort_order`（整数）で保持し、CSV 出力も同じ順序。
- キーボードでは `Alt + ↑/↓` で 1 行移動。

#### Undo / Redo
- クライアント側で行編集履歴を管理（最大 20 ステップ）。ショートカット `Cmd/Ctrl + Z` / `Shift + Cmd/Ctrl + Z`。
- Undo した内容は draft 状態でのみ有効。`in_review` 以降は Undo を制限（警告表示）。

#### 一括操作
- 複数行選択（チェックボックス）をサポートし、削除 / 税区分変更を一括で適用可能。
- 選択中はヘッダーに「○件選択中」のバナーを表示し、操作完了後は選択解除。

#### 自動計算
- 行の `amount` 合計をリアルタイムに documents へ反映し、差異がある場合は警告。
- 将来の税計算拡張に備え、`tax_category` ごとの小計も算出して UI に表示。

### マスターデータ方針（A3-03）
#### 管理対象
- 勘定科目マスター `account_titles`
- 税区分マスター `tax_categories`
- 相手先候補 `vendors`（過去入力から自動生成）

#### 勘定科目マスター
- 保持場所：Supabase `account_titles` テーブル（列：`id`, `name`, `code`, `is_default`, `sort_order`）。
- 初期データ：材料費・消耗品費・荷造運賃・通信費など、弥生白色申告で多用する 10 件程度をプリセット。
- UI：エディタ内セレクトはこのテーブルを参照。`code` で検索可能（例：`EXP-MAT`）。
- ユーザー定義：MVP では固定リスト、将来は追加編集機能を検討。

#### 税区分マスター
- `tax_categories` テーブルに `id`, `label`, `rate`, `description`, `is_active` を持たせる。
- 初期データ：`standard_10`（10%）、`reduced_8`（8%）、`exempt`（非課税）。
- 弥生 CSV で必要なコードを `external_code` として保持し、エクスポート時に利用。
- UI ではラジオボタン or セレクトで表示し、説明 ToolTip に `description` を表示。

| value | ラベル | 説明 |
| --- | --- | --- |
| `standard_10` | 課税売上 10% | 標準税率（10%）対象取引。 |
| `reduced_8` | 課税売上 8%（軽減） | 軽減税率 8% 対象取引。 |
| `exempt` | 非課税 | 非課税取引（送料含む必要に応じて）。 |

> 弥生 CSV の税区分コードは後続タスク（B1-02）で別表マッピングを定義し、この内部値を起点に連携する。

#### 相手先候補
- 新規テーブルは作らず、`entries` から `vendor` の distinct 値を取得してローカルキャッシュ。
- 最近使用した 10 件を優先表示し、検索に一致しない場合はフリーテキスト入力を許可。
- 将来、`vendors` サジェストを Supabase 関数で提供する拡張スペースを確保。

#### データ同期 / キャッシュ
- account_titles / tax_categories はビルド時に静的 JSON 化し、初回ロード時に SPA へ配布。バックグラウンドで Supabase から最新をフェッチし、差分があれば更新。
- キャッシュ更新時はバージョン番号（`master_version`）を README に記録し、マイグレーション管理と連動させる。

#### 権限・変更フロー
- マスター更新は管理者ロールのみ許可。RLS で `role = 'admin'` のみ `insert/update/delete` できるよう制限。
- 一般ユーザーは読み取り専用。UI に「固定の科目」「税区分」の説明を入れて期待値を合わせる。
- 将来的にユーザー個別のマスターを許可する場合、`account_titles` や `tax_categories` に `owner_id` を追加し、共有/個別を切り替えられる設計にする。

### ステータス操作 UX（A3-04）
#### ステータス表示
- ドキュメントヘッダーに現在のステータスバッジ（色分け）と最終更新メタ（`更新者 / 更新日時`）を表示。
- ステータス横に「進行度メーター」を設置し、`draft → in_review → confirmed` の 3 段階を視覚的に示す。

#### ステータス変更 UI
- `draft` → `in_review`：エディタ内の「レビュー依頼」ボタン。クリック時に条件チェックを実行し、満たしていない項目はリストアップしてモーダルに表示。
- `in_review` → `confirmed`：画面上部に固定されたプライマリボタン「確定」。成功時はサクセストーストを表示し、CSV 対象になった旨を案内。
- `confirmed` → `in_review`：`confirmed` バッジ横に「再オープン」リンク。クリックで理由入力モーダルを出し、ログに記録。
- `in_review` → `draft`：エディタ下部の「下書きに戻す」ボタン。

#### バリデーション / エラーメッセージ
- ステータス変更時に実行するチェック：必須フィールド入力、金額 > 0、税区分が選択済み、行が 1 件以上。
- 失敗した項目はモーダル内で列挙し、該当行・フィールドにジャンプできるリンクを付与。
- `confirmed` への遷移時に Supabase 側でもトランザクションチェックを行い、サーバーエラー時はユーザーに「再試行/キャンセル」の選択肢を提示。

#### ロックポリシー
- `confirmed` 状態ではエディタのフィールドは read-only 表示に切り替え、変更には「再オープン」が必要である旨をヘルプテキストで伝える。
- `in_review` 状態では主要フィールド（勘定科目・金額など）を編集すると履歴が残ることを示し、編集実行前に軽い警告を出す（トグルでオフ可）。
- 2 人以上が同時編集しないよう、`documents` に `locked_by` / `locked_at` を追加し、一定時間操作がない場合はロックを自動解除。

#### 通知 / アクティビティログ
- ステータス変更時にアクティビティログ（`documents_activity` テーブル）へ記録し、右側パネルで最新 10 件を表示。
- `confirmed` になったドキュメントは `/documents` 一覧にもバッジとチェックマークを表示し、CSV エクスポート対象であることを明示。
- 将来的にメール通知や Slack Webhook を追加する余地を残すが、MVP では UI 内通知のみ。

### CSV 下書き仕様書（A4-01）
#### 抽出条件
- documents.status = `confirmed` のみ対象。
- 抽出期間：ユーザー指定の取引日範囲（`entries.date`）でフィルタ。開始日/終了日は必須。
- ソースや金額帯での追加フィルタにも対応（オプション）。
- 削除済み（ソフトデリート）や in_review の entries は含めない。

#### カラム定義（暫定）
| CSV カラム | 型 | 例 | 説明 |
| --- | --- | --- | --- |
| `date` | YYYY/MM/DD | 2024/03/15 | 取引日（`entries.date`） |
| `amount_in` | 数値（整数） | 0 | 入金金額。収入がある場合のみ値を入れる。 |
| `amount_out` | 数値（整数） | 9800 | 出金金額。経費の場合はこちらに金額をセット。 |
| `vendor` | 文字列 | Amazon.co.jp | 相手先。最大 50 文字。 |
| `account_title` | 文字列 | 消耗品費 | 勘定科目（`account_titles.name`）。 |
| `tax_category` | 文字列 | standard_10 | 税区分コード。弥生側でマッピング。 |
| `description` | 文字列 | LED デスクライト | 摘要（任意）。 |
| `document_id` | UUID | 3f8a... | 元 PDF ドキュメント ID。内部トレース用。 |

- 文字コード：UTF-8、改行コード：LF。
- 本番ダウンロード CSV はヘッダー行なし（弥生 CSV ファイル取込でヘッダー付きが拒否されるため）。
- `/export` 画面の下書きプレビューは列名を示すためにヘッダー行を含める。
- 区切り文字はカンマ。値にカンマが含まれる場合はダブルクォーテーションでエスケープ。
- 金額は正の整数。マイナス値は別途調整仕訳で対応。

#### データ整合性
- `document_id` ごとに entries をまとめ、同一 PDF の仕訳が連続するようソート（`documents.created_at` → `entries.sort_order`）。
- 金額合計が documents の合計と一致しない場合はエクスポート前に警告。
- tax_category が不明な場合はエクスポートさせず、エラーリストに表示。

#### CSV ダウンロード（B-実装-02）
- `/api/export` で JSON 形式の下書きプレビューを取得し、問題がなければ `/api/export/download` に POST することで CSV ファイルを Shift_JIS 形式でダウンロードできる。
- ダウンロードボタンは `/export` 画面の結果カード内に表示され、ファイル名は `entries_{from}_{to}.csv`。
- 弥生の仕様に合わせ、ダウンロード CSV はヘッダー無しで `date,amount_in,...` の順にデータ行のみを出力する（プレビューはヘッダー付き）。整合性チェックで問題がある場合はダウンロードをブロックし、エラー内容を UI に表示する。

#### サンプル CSV
```csv
date,amount_in,amount_out,vendor,account_title,tax_category,description,document_id
2024/03/15,,9800,Amazon.co.jp,消耗品費,standard_10,"LED デスクライト",3f8a2a9d-...
2024/03/16,,2500,楽天ショップA,材料費,reduced_8,,6c1f7b54-...
```

### CSV 出力処理設計（A4-02）
#### ユースケース
- 入力：期間（開始日/終了日）、ソースフィルタ（任意）、`document_id` の直接指定（任意）。
- 処理：`entries` を抽出 → 並び替え → CSV 化 → Supabase Storage / 一時ファイルに保存 → ダウンロード URL を返却。
- 出力：CSV ファイル（`receipts_export_{from}_{to}.csv`）、ログ ID。

#### 生成フロー
1. `/export` 画面で条件を入力し「CSV 作成」クリック。
2. Next.js Route Handler（edge runtime）から Supabase RPC or Stored Procedure を呼び、対象 entries を取得。
3. サーバー側でストリーミング（Node.js `ReadableStream`）を使って CSV を生成し、そのままレスポンスとして返す。
4. 同時に Supabase Storage の `exports/` フォルダへバックアップを保存（後で再ダウンロード可能）。
5. 完了後、UI に「ダウンロード & 履歴」カードを表示。

#### バッチ / パフォーマンス
- 1 ファイルあたり最大 5,000 行を想定。超える場合は日付範囲を分割するようユーザーに案内。
- Supabase からの取得はページングで 1,000 件ずつフェッチし、サーバー側でストリーム結合。
- 生成処理中は Progress UI を表示し、10 秒以内に完了しない場合はスピナー＋メッセージで待機させる。

#### エラー / リトライ
- CSV 生成失敗時：エラーメッセージに「再試行」ボタン、ログ ID を提示。
- Storage への保存で失敗した場合、レスポンスとしてはダウンロード可でもバックアップが無いことを通知し、後から再生成できるよう履歴にステータスを残す。
- サーバーエラー（Supabase RPC 失敗等）はエラーログを `exports_logs` テーブルに記録し、ユーザーに再実行を促す。

#### セキュリティ
- エクスポート処理は認証必須。ユーザーの権限に応じて参照可能な documents のみを対象にする（RLS + API レベルでチェック）。
- 一時 URL は署名付き URL を利用し、60 分で失効。履歴から再ダウンロードする際も新しい URL を発行。

#### ログ / 履歴
- `exports_logs` テーブルに以下を保存：`id`, `requested_by`, `from_date`, `to_date`, `filters`, `status`, `file_path`, `rows_count`, `created_at`。
- `/export` 画面に最近 10 件の履歴を表示し、成功/失敗ステータスを視覚化。成功した行には「再ダウンロード」リンクを設置。
- 履歴からエラーを選択すると詳細（エラーメッセージ、対象 document）を確認できるようにする。

### ダウンロード UI（A4-03）
#### `/export` 画面構成
- 上部：期間指定フォーム（From/To）、ソースフィルタ、`document_id` 指定のテキストボックス。
- 中央：進捗カード + 結果カード。
- 下部：エクスポート履歴テーブル。

#### 期間指定フォーム
- DateRangePicker で開始日・終了日を指定。未入力時は無効ボタン。
- オプションで「過去 30 日」「今年」などのショートカット。ソースフィルタ、金額帯をアコーディオンで表示。
- 「CSV 作成」ボタンはフォーム右上に固定し、クリック時にスピナー表示。

#### 進捗/結果カード
- 進捗：CSV 生成中はステップ表示（抽出 → 生成 → 保存）とプログレスバー。
- 成功時：ファイル名、行数、作成日時を表示し、「ダウンロード」「履歴で確認」ボタンを提供。
- 失敗時：エラーメッセージ + 再試行ボタン + ログ ID を表示。

#### 履歴テーブル
| カラム | 内容 |
| --- | --- |
| 期間 | `2024/03/01 - 2024/03/31` など。 |
| ソース | フィルタ条件を表示。 |
| 行数 | 出力行数。
| ステータス | 成功 / 失敗 / 実行中（バッジ）。 |
| ファイル | ダウンロードリンク（成功時のみ）。 |
| 実行者 | `requested_by`（ユーザー名）。 |
| 実行日時 | `created_at`。 |
- 失敗行には「詳細を見る」リンクでエラー内容をモーダル表示。

#### UX 補足
- 直近の成功結果は画面右上にピン留めし、他画面でも簡易ダウンロードできるよう通知バナーを表示。
- ダウンロード完了後に「弥生での取り込み手順」へのリンクを表示し、次のステップを誘導。
- モバイル表示ではフォーム→進捗カード→履歴の順に縦配置。履歴テーブルはカード表示に切り替え。
- 履歴が空の場合はガイドカード（「期間を選んでエクスポートを開始」）を表示。

### 弥生 CSV 公式仕様メモ（B1-01）
- 参照元：弥生「スマート取引取込 → CSVファイル取込」ヘルプより（項目選択画面の説明）。
- 区分は「日付」「金額」「摘要」「軽減税率」「請求書区分」「選択解除」。日付・金額はいずれかの項目を必ず選択する必要がある（赤字エラー時は選択状況や CSV データを再確認）。
- 日付は `日付（年月日）` で一括指定するか、`日付（年）` `日付（月）` `日付（日）` の3列を個別指定する。年月日列を選択した場合は他の日付列の選択は不可。
- 金額は `金額（入金）` `金額（出金）` 列を別々に指定する。入出金列は使用しない。
- 摘要列は任意だが、弥生上で仕訳の説明に使用される。
- `軽減税率` 列を指定すると軽減対象かどうかを弥生が判定する。`請求書区分` 列は適格請求書区分の情報を保持している場合に使用する。
- 項目を選択すると画面上で「済み」と表示される仕様。`（選択を解除する）` を選ぶことで一度割り当てた項目を解除可能。

> **対応方針**：本アプリの CSV は `date`（YYYY/MM/DD）、`amount`（税込・正数）、`description`、`tax_category` などを出力済み。弥生側で 1 列の日付・金額にマッピングできるよう維持し、軽減税率フラグや請求書区分が必要になった場合は追加列を設計する。B1-02 で内部フィールドとの対応表を作成し、弥生 UI 上の選択手順も README に追記する。

### 弥生向けマッピング表（B1-02）
| アプリ側フィールド | 弥生 CSV 項目（UI の表示名） | 備考 |
| --- | --- | --- |
| `date` | 日付（年月日） | `YYYY/MM/DD` 形式で出力。年/月/日分割列は使用しない前提。 |
| `amount_in` | 金額（入金） | 入金金額がある場合のみセット。通常は空欄。 |
| `amount_out` | 金額（出金） | 出金金額をセット。経費入力では主にこちらを使用。 |
| `vendor` | 摘要 | 弥生の摘要に相手先情報を入れる。50文字制限を目安にトリム。 |
| `description` | 摘要（補助列） | 必要に応じて `vendor` と結合した文字列を出力する案も検討。 |
| `tax_category` | 軽減税率 | `reduced_8` の場合に「対象」判定できるよう、`yes/no` や `1/0` など弥生が受け取れる形式に変換する。`standard_10`/`exempt` は空欄。 |
| `document_id` | （弥生独自項目なし） | 内部トレース用。弥生 UI には割り当てないが CSV には保持し、再インポート時の突合に使う。 |

- 将来的に請求書区分や適格請求書番号が必要になった場合は追加列を検討し、弥生側の「請求書区分」項目にマッピングする。
- マッピング手順：弥生の「CSVファイル取込」画面で各列を選択し、「済み」表示を確認。`日付（年/月/日）` や `金額（入金/出金）` を選ばないよう注意する。

#### サンプル CSV（弥生用）
```csv
date,amount,vendor,account_title,tax_category,description,document_id
2024/03/15,9800,Amazon.co.jp,消耗品費,standard_10,"LED デスクライト",3f8a2a9d-...
2024/03/16,2500,楽天ショップA,材料費,reduced_8,,6c1f7b54-...
```
- 弥生 UI では上記の `date` を「日付（年月日）」、`amount_in` を「金額（入金）」、`amount_out` を「金額（出金）」、`vendor`（または `description`）を「摘要」に割り当てる。軽減税率列は `tax_category = reduced_8` の行のみ「対象」と判定できる値へ変換するロジックを実装予定。

### 入力バリデーション要件（B2-01）
| フィールド | 要件 | エラー表示例 |
| --- | --- | --- |
| `date` | `YYYY-MM-DD` 形式。未来日不可（当年末＋1カ月まで許容）。空欄禁止。 | 「取引日は必須です」「未来日の取引は登録できません」 |
| `vendor` | 1〜50 文字。半角/全角混在可。先頭末尾の空白は自動トリム。 | 「相手先は 50 文字以内で入力してください」 |
| `account_title` | マスター内の値のみ選択可。未選択禁止。 | 「勘定科目を選択してください」 |
| `amount_in` | 正の整数。最大 1,000,000,000（9 桁）。0 も可（入金が無い場合は 0）。 | 「入金金額は 0 以上の整数で入力してください」「金額が大きすぎます」 |
| `amount_out` | 正の整数。最大 1,000,000,000（9 桁）。0 も可（出金が無い場合は 0）。 | 「出金金額は 0 以上の整数で入力してください」「金額が大きすぎます」 |
| `tax_category` | `standard_10`,`reduced_8`,`exempt` のいずれか。未選択禁止。 | 「税区分を選択してください」 |
| `description` | 0〜100 文字。改行可。 | 「摘要は 100 文字以内で入力してください」 |
| `source` | `amazon`,`rakuten`,`manual`,`other` のいずれか。アップロード時に設定し、後から変更可能。 | - |
| ステータス | `draft` 以外で未入力フィールドがあれば遷移不可。 | 「未入力の行があります（行番号）」 |

- `documents` / `entries` の `created_by` は常に認証ユーザー ID を設定し、RLS で `created_by = auth.uid()` のみ読み書き可能にする。
- CSV エクスポート前に上記バリデーションを再実行し、不備がある行をリストアップして `confirmed` 状態へ遷移させない。

### エクスポート前整合性チェック（B2-02）
- 対象：`documents.status = confirmed` かつ 指定期間内の entries。
- チェック内容：
  1. **ステータス混入**：`draft` / `in_review` の entries が含まれていないか（ある場合は document ごとにエラー表示）。
  2. **必須列欠落**：`date`,`amount_in/out`,`vendor`,`account_title`,`tax_category` が空の行を検出。
  3. **金額整合**：entries の `amount_in + amount_out` が documents の集計と一致するか。ズレた場合は差額を表示し、エクスポート不可。
  4. **文字数制限**：`vendor` 50 文字超、`description` 100 文字超を検出し、自動トリム or ユーザー修正を要求。
  5. **tax_category 変換**：`reduced_8` 以外で軽減税率フラグが立っていないか、サポート外値が混入していないか。
  6. **日付範囲**：指定期間外の取引が混入していないか。特に `date` がフィルタ条件外なら警告。
- 結果表示：
  - `/export` の結果カードに「整合性 OK」または「× エラー n 件」のリストを表示。
  - エラー行には document / entry のリンクを付け、修正画面へ遷移できるようにする。
- 実装方針：Next.js Route Handler 内で検証ロジックを共通化（`app/modules/bookkeeping/application/export-validators.ts`）。Supabase RPC 側でも最低限のチェック（ステータス一致、NULL 禁止）を行い二重防御する。

### エラー通知 UX（B2-03）
- **通知経路**：
  - フロントエンド：`/export` 画面でトースト通知 + 結果カードにエラー詳細を表示。
  - 重大エラー時（サーバー例外）はメール/Slack 通知を将来的に検討。MVP では UI 内通知のみ。
- **エラー種別と表現**：
  1. **入力不備**（整合性チェック失敗）：エラーリストに行番号・原因を表示し、「編集に移動」ボタンで対象ドキュメントへ遷移。
  2. **エクスポート処理失敗**（Supabase 取得/Storage 保存）：赤色トーストに「再試行」「ログ ID をコピー」ボタンを表示。`exports_logs` に詳細を記録。
  3. **ネットワーク切断/タイムアウト**：黄色トーストで「接続を確認して再実行」メッセージを表示し、一定時間後に自動消去。
- **再実行 UX**：
  - 結果カード内に「再試行」ボタンを配置。最後に使用した条件を保持し、ワンクリックでやり直せるようにする。
  - エラー発生時に `exports_logs` へ `status = failed` を記録し、履歴テーブルからも再実行できるようリンクを設置。
- **アクセシビリティ**：トーストは `aria-live="assertive"` で読み上げ対応。キーボード操作のみでもエラー詳細と再試行にアクセスできるようフォーカスマネジメントを行う。

### 弥生取込リハーサル計画（B3-01）
1. **テストデータ準備**
   - パターン1：標準税率 10%（Amazon 購入）
   - パターン2：軽減税率 8%（食品など楽天購入）
   - パターン3：非課税（送料等）
   - 各パターンで 1〜3 行の entries を含む documents を作成し、CSV を出力。
2. **弥生側操作手順**（チェックリスト）
   - [ ] 弥生白色申告オンラインにログイン
   - [ ] 「スマート取引取込 → CSVファイル取込」を開く
   - [ ] サンプル CSV をアップロード
   - [ ] 項目選択画面で `日付（年月日）` / `金額（入金）` / `金額（出金）` / `摘要` / `軽減税率` を割り当て
   - [ ] 取り込み前のプレビューで日付・金額・摘要・税区分を確認
   - [ ] 取込実行
   - [ ] 仕訳一覧で反映を確認（税区分や摘要が期待通りか）
3. **確認観点**
   - 日付フォーマット（年/月/日）が正しく認識されるか
   - 金額が正しく出金として記録されているか（符号ミスがないか）
   - 摘要の文字化けがないか（UTF-8/SJIS 変換）
   - 軽減税率フラグが `reduced_8` の行でのみ ON になるか
   - ヘッダー無し CSV で正常に取り込めるか（ヘッダー付きは弥生が拒否するため）

#### リハーサル結果（2024-11-20 時点）
- Supabase で作成した confirmed ドキュメント 1 件（entries 1 行：`2025-11-15, amount_out=1200, vendor=テストショップA, account_title=消耗品費, tax_category=standard_10`）を対象に `/export` から CSV を出力。
- 出力ファイルはヘッダーなし `date,amount_in,amount_out,vendor,account_title,tax_category,description,document_id` 順で 1 行のみを出力。
- 弥生白色申告オンライン Studio の「スマート取引取込 → CSVファイル取込」にて以下を操作：
  1. ファイル選択 → プレビュー。
  2. 項目選択画面で `date` = 日付（年月日）、`amount_in` = 金額（入金）、`amount_out` = 金額（出金）、`vendor` = 摘要 に割り当て。今回のテスト行は `standard_10` のみだったため `tax_category` は割り当てずに進め、後続タスクで `reduced_8` 行を追加して確認予定。
  3. プレビューで金額が出金として表示され、文字化けなし。
  4. 取込実行 → 取込履歴で成功ステータス、取引一覧にも反映を確認。
- この結果をもって「ヘッダー無し + amount_in/amount_out 分離ファイル」で弥生側インポートが通ることを確認済み。
4. **フィードバック反映**
   - エラーや注意点は README の B1/B2 セクションへ追記
   - 弥生 UI のスクリーンショットを取得し、手順書作成（B3-02 で活用）

### 手順書 & 落とし穴ナレッジ（B3-02）
#### 取込手順書（ドラフト）
1. CSV を本アプリから出力し、ファイル名とハッシュを控える。
2. 弥生白色申告オンラインにログイン → 「スマート取引取込 → CSVファイル取込」。
3. 「ファイルを選択」で対象 CSV をアップロード。
4. 項目選択ダイアログで以下を選択：
   - `日付（年月日）` = `date`
   - `金額（入金）` = `amount_in`
   - `金額（出金）` = `amount_out`
   - `摘要` = `vendor`（必要に応じて `description`）
   - `軽減税率` = `tax_category`（`reduced_8` を対象に）
5. プレビュー画面でデータを確認し、問題なければ「取込」実行。
6. 取り込んだ取引を「取引一覧」で確認し、必要に応じて弥生側で仕訳に変換。

#### リハーサルで得られた注意事項
- 「CSV にヘッダー行が含まれている」場合はアップロード時点でエラーになるため、本番ダウンロードは必ずヘッダー無しを維持する。
- 軽減税率列は、今回のテストでは標準税率のみだったため未割当で進めた。`reduced_8` の実データを登録した上で、列を割り当てた際に「対象」が正しく付与されるかを次フェーズで再確認する。
- 金額は正の整数で出力され、弥生側で入金/出金どちらに割り当てるかは列選択に依存する。`amount_in` と `amount_out` を同時に設定すると、弥生が二重計上するため必ず片方のみ入力する。（アプリ側はバリデータで片方 0 を保証）
- 取込後に `document_id` は弥生には表示されないため、再取込回避はアプリ側でダウンロード履歴を管理して対応する。

#### 落とし穴 / 注意点メモ
- **文字コード**：弥生は Shift_JIS でも受け付けるが、本アプリは UTF-8 を出力。弥生側で文字化けが発生した場合は UTF-8 を前提としている旨を手順書に明記し、必要なら Shift_JIS 変換オプションを追加検討。
- **改行コード**：LF。Windows で開いても崩れないようにする。
- **金額符号**：出金のみの場合でも弥生は負の値で出金扱いにするケースがある。取込結果で出金/入金の向きが逆になっていないかチェック。
- **軽減税率**：`tax_category = reduced_8` の行のみ値を設定し、その他は空欄にする。弥生が期待する値（例：`対象`/空）を今後のリハーサルで確定する。
- **請求書区分**：未対応。必要になった場合は追加列を検討（B1-02 方針参照）。
- **ヘッダー行**：弥生 CSV ファイル取込はヘッダーなしを要求するため、ダウンロードファイルはデータ行のみ。手順書でも「ヘッダーなし」を明記し、プレビュー（ヘッダー付き）との差異に注意。
- **データ重複**：同一 CSV を複数回取り込むと二重登録されるため、document_id や期間で管理し、既存データと突合する運用手順を記載。

- 本節の内容はリハーサル結果に応じて更新し、スクリーンショットや動画リンクを README 末尾または別資料に添付する。

## 📑 画面構成
- `/`                - ダッシュボード（簡易）
- `/documents`       - PDF一覧 ＋ アップロード
- `/documents/[id]`  - 仕訳編集画面
- `/export`          - CSV出力画面

## 🏗️ アーキテクチャ（軽量ヘキサゴナル）
```
app/
  ├ ui/                - ページ・UIコンポーネント
  ├ modules/
  │   └ bookkeeping/
  │        ├ domain/        - ドメインモデル
  │        ├ application/   - ユースケース
  │        ├ infra/         - Supabaseリポジトリ
  │        └ ui/            - 入力/一覧UI
  └ lib/
```

- UI → application → domain
- UI → application → infra
- domain はロジックのみ、infra は Supabase で保存、application は「PDFアップロード」「仕訳登録」「CSV生成」などのユースケースを担当

## 🚀 将来的な拡張（MVPでは未対応）
- Amazon / Rakuten 領収書の HTML パースによる半自動入力
- OCR（Tesseract / Vision API）での自動抽出
- Playwright による Amazon / Rakuten 自動ダウンロード
- 適格請求書（インボイス番号）チェック
- CSVの自動アップロード
- Supabase Edge Functions / ワーカーによる PDF 解析パイプライン（PDF → テキスト抽出 → ハイライト情報保存）

## ✔️ 今後の進め方
1. **ワークフローを2段階で整理する**：
   - Phase A（画像 / PDF → 仕訳データ → CSV 下書き）では、Amazon/Rakuten などの領収書PDFを取り込み、必要項目を入力できる安定した UI・データ構造を完成させる。
   - Phase B（CSV → 弥生白色申告への取り込み）では、弥生の「スマート取引取込 → CSVファイル取込」要件を満たす出力フォーマットを固定し、confirmed 状態のみを対象にしたエクスポート機能を実装する。
2. **Phase A を優先実装**：PDFアップロード、ドキュメント一覧、仕訳編集（ドラフト〜確定）までを MVP の核として完成させ、入力作業の効率化を先に達成する。
3. **Phase B の検証と改善**：弥生側での CSV 取り込みテストを繰り返し、必要に応じて列定義やバリデーションを README に反映していく。
4. **README をマスター仕様とする**：要件変更・決定事項は README に追記し、コード実装フェーズに入る前に常に README を最新状態に保つ。

### Phase A（前処理アプリ）タスク
- [x] **A1-01 Supabase スキーマ確定** — documents / entries テーブル定義、主キー・外部キー・必須カラムを README に固定する。
- [x] **A1-02 マイグレーション & ストレージ命名規則** — Supabase Migration の雛形とストレージパス（例：`receipts/{year}/{id}.pdf`）のルールを決める。
- [x] **A1-03 ステータス遷移モデル策定** — `draft → in_review → confirmed` の条件・戻し方・ユーザー権限を文章化する。
- [x] **A2-01 PDF アップロード UX 設計** — ドラッグ&ドロップ、進捗表示、バリデーション（拡張子/サイズ）のフロー図を作成。
- [x] **A2-02 Supabase Storage 連携設計** — マルチファイルアップロードの API 呼び出し、エラー時リトライ、メタデータ書き込み順序を決める。
- [x] **A2-03 ドキュメント一覧 UI 設計** — ステータス・期間・ソースのフィルタ、並び替え、一覧テーブルのカラム構成を定義。
- [x] **A3-01 仕訳エディタ フォームレイアウト** — 日付/金額/税区分等の入力順、キーボードショートカット、必須/任意フィールドを決める。
- [x] **A3-02 行操作ロジック設計** — 行の追加・複製・削除や自動計算ルール、Undo/Redo ポリシーを記述。
- [x] **A3-03 マスターデータ方針** — 勘定科目・税区分の候補管理（ローカル定義 or Supabase テーブル）と標準セットを決める。
- [x] **A3-04 ステータス操作 UX** — エディタ上で draft/in_review/confirmed を切り替える UI、エラーメッセージ、ロック方針を設計。
- [x] **A4-01 CSV 下書き仕様書** — 確定データの抽出条件、列順、データ型、小数/通貨表現などを記述。
- [x] **A4-02 CSV 出力処理設計** — エクスポートユースケースの入出力、Supabase からのフェッチバッチサイズ、失敗時の再実行方針を定義。
- [x] **A4-03 ダウンロード UI** — 期間指定フォーム、進捗表示、完了通知、履歴（いつ誰が出力したか）を UI レベルでまとめる。

#### Phase A 実装ステップ
- [x] **A-実装-01** Supabase の `documents` / `entries` テーブルを作成し、マイグレーション・環境変数（`NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` / `SUPABASE_SERVICE_ROLE_KEY`）を設定する。
- [x] **A-実装-02** Mock リポジトリを Supabase 実装に置き換え、`/documents` / `/documents/[id]` で実データを表示できるようにする。
- [x] **A-実装-03** `DocumentEditor` からステータス・メモを保存する API / アクションを実装する。
- [x] **A-実装-04** PDF アップロード UI と Supabase Storage 連携（モック可）を `/documents` に組み込む。
- [x] **A-実装-05** CSV 下書き生成（モック可）と `/export` 画面の整合性チェック表示を実装する。
- [x] **A-実装-06** README に沿った命名・構成を再確認し、Phase A の受け入れ確認を完了する。（Next.js プロジェクト構成・命名規則・環境変数設定を README と照合済み）

### Phase B（弥生連携）タスク
- [x] **B1-01 弥生 CSV 公式仕様リサーチ** — 必須列、文字コード、ヘッダー有無など一次情報を入手し README に引用。
- [x] **B1-02 弥生向けマッピング表作成** — アプリ内部フィールドとの対応表とサンプル CSV（最小・複数行）を README に掲載。
- [x] **B2-01 入力バリデーション要件整理** — 勘定科目/税区分の選択肢制限、金額・日付のフォーマット、未入力チェックを一覧化。
- [x] **B2-02 エクスポート前整合性チェック設計** — confirmed 以外の混入、必須列欠落、文字数制限などの検証フローを記述。
- [x] **B2-03 エラー通知 UX** — CSV 生成失敗時の再実行方法、問題行ハイライト、ユーザーへの案内メッセージを設計。
- [x] **B3-01 弥生取込リハーサル計画** — テストデータ、取込手順、確認観点（税区分反映、文字化け）をチェックリスト化。
- [x] **B3-02 手順書 & 落とし穴ナレッジ** — 実データでのインポート手順書と既知の注意点（文字コード、改行コードなど）を README に追記できる形で整理。

#### Phase B 実装ステップ
- [x] **B-実装-01** 弥生 CSV の正式仕様（文字コード、ヘッダー、列マッピング）を Studio テスト結果で検証し、README を確定させる。
- [x] **B-実装-02** `/export` の CSV 出力ロジックを求められた列順・文字コード（UTF-8 or Shift_JIS）でファイルダウンロードできるよう実装する。
- [x] **B-実装-03** CSV 出力前の整合性チェックを RLS/DBレベルの検証結果と同期させ、UI に詳細エラーを表示する。
- [x] **B-実装-04** 取込リハーサル結果を README に反映し、弥生への操作手順・注意点を手順書にまとめる。
- [x] **B-実装-05** Phase B の受け入れ確認（弥生への実データ取込、README/コード一貫性チェック）を完了する。

### Phase C（PDF解析 / OCR）タスク案
- [x] **C1-01 技術調査** — pdf.js / Tesseract / Vision API などの抽出精度・コスト・実装方法を比較し、README に要件をまとめる。
- [x] **C1-02 アーキテクチャ設計** — アップロード後に Edge Function / Queue で非同期解析するフロー、リトライや失敗時の通知を文章化。
- [ ] **C1-03 スキーマ拡張** — `documents` に `analysis_status`, `analysis_payload`、`document_texts` テーブル等を追加する設計案を記載。
- [ ] **C2-01 PDFテキスト抽出 PoC** — pdf.js + Next.js Route Handler でテキスト抽出し、`documents` に保存するモックを実装。
- [ ] **C2-02 OCR PoC** — 画像領収書に対し Tesseract もしくは Vision API を呼び、ログ/サンプル結果を README に掲載。
- [ ] **C2-03 セキュリティ/コスト評価** — API キー管理、外部送信の個人情報リスク、処理コスト見積もりをまとめる。
- [ ] **C3-01 UI統合** — `/documents/[id]` に解析結果カード（テキスト原文・推定日付/金額等）を表示し、クリックで入力フィールドに反映できる UX を設計。
- [ ] **C3-02 オペレーション設計** — 解析ジョブの再実行、手動上書きとの整合性、トレースログ/監査ログを README へ記載。
#### C1-01 調査結果メモ
- **pdf.js (Mozilla)**: OSSで実装可能、Next.js Route Handler / Edge Functionで動く。テキストレイヤー抽出に適する一方、画像ベースPDFは非対応。まずは pdf.js を優先採用し、抽出失敗時のみOCRにフォールバックする方針。
- **Tesseract OCR**: 無料だがWASM版は処理が重く、日本語精度は前処理依存。将来的にスキャン領収書対応に使う可能性があるが Phase C 初期では採用しない。
- **Vision API / Textract**: 高精度だがコストと個人情報送信の同意が必要。PDF解析の精度要件が上がった段階で採用検討。
- **基本方針**: 「まず pdf.js でテキスト抽出 → 正規表現で日付/金額/ショップを候補化」。抽出できない場合に備えて C2-02 で OCR PoC を準備しつつ、実運用は pdf.js が主役。

#### C1-02 アーキテクチャ設計（pdf.js 非同期解析）
1. **イベント起点**
   - `/documents` で PDF をアップロード → Supabase Storage `receipt-documents` にファイル保存 → `documents` レコード作成（`status=draft`）。
   - Storage の `objects.insert` をトリガーに Supabase Edge Function を起動し、解析ジョブを `document_analysis_jobs` テーブルへ `pending` で登録。

2. **解析ジョブ実行**
   - Edge Function がジョブを `processing` に更新し、Storage から PDF をダウンロード。
   - pdf.js（Node 版）でページ単位にテキストを抽出し、`document_texts`（`document_id`, `page`, `content`, `confidence`, `created_at`）へ保存。
   - 正規表現で推定 `date` / `amount_out` / `vendor` / `order_id` を抽出し、`documents.analysis_payload`（JSONB）に格納。
   - 正常完了で `analysis_status=completed`、ジョブは `completed` に更新。失敗時は `analysis_status=failed` にして `last_error` を保持。

3. **再実行・リトライ**
   - ジョブは最大 3 回まで自動リトライ。超過した場合は `failed` で固定し、UI に「再解析」ボタンを表示して新しいジョブを作成。
   - 解析処理のタイムアウト（例: 60 秒）を超える大型PDFは `timeout` 理由を記録し、ユーザーに分割アップロードを促すメッセージを表示。

4. **UI 連携**
   - `/documents/[id]` で `analysis_status` を確認し、`processing` 中はスピナー表示、`completed` で「解析結果」カードを表示。
   - カードにはページ別テキストの抜粋と推定フィールドを一覧表示し、クリックすると対象入力欄に反映（Undo 可）。

5. **セキュリティ / 監査**
   - Edge Function には Service Role Key ではなく Function 秘密鍵を使用し、Storage からダウンロードしたPDFは処理後すぐ破棄。
   - `document_analysis_jobs` に `duration_ms`, `pages_processed` を記録し、監査ログ（Supabase Logflare 等）へも送信。個人情報を外部サービスへ送信しないため、privacy ガイドラインは Supabase 内完結で済む。

6. **将来拡張ポイント**
   - 同じ `document_analysis_jobs` インターフェースで OCR 実装（Tesseract / Vision API）へ差し替え可。`analysis_engine` カラムを追加し、ヘキサゴナルパターンで `PdfTextExtractor` インターフェースを切り替える。
   - `analysis_payload` にはハイライト位置情報（座標）を保存できる余地を残し、将来的な「PDFプレビュー + ハイライト」への受け渡しを容易にする。
